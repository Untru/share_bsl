# Разработка Telegram-бота на 1Script с фреймворком Autumn: от архитектуры до реализации

## Введение

В этой статье мы рассмотрим процесс создания Telegram-бота для разбора и публикации исходного кода конфигураций 1С, используя язык 1Script и фреймворк Autumn. Проект демонстрирует современные подходы к разработке на платформе 1С:Предприятие и показывает, как можно создавать сложные приложения с использованием архитектурных паттернов.

## Архитектура приложения

### Общая структура

Наше приложение построено по принципу **слоистой архитектуры** с четким разделением ответственности:

```
┌─────────────────────────────────────────────────────────────┐
│                    Presentation Layer                       │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │  ТелеграммБот   │  │  КомандаФайл    │  │ КомандаКлав. │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                     Business Layer                          │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │МенеджерПубликац.│  │  Декомпилятор   │  │ Публикатор   │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                      Data Layer                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌──────────────┐ │
│  │ИсторияПубликаций│  │ ИсторияФайлов   │  │ Autumn Data  │ │
│  └─────────────────┘  └─────────────────┘  └──────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### Паттерн Команда (Command Pattern)

Одним из ключевых архитектурных решений является использование **паттерна Команда** для обработки различных типов сообщений Telegram:

```oscript
&Желудь
&Прозвище("Команда")
Функция ПодходитПоУсловию(Сообщение) Экспорт
    // Логика определения подходящей команды
КонецФункции

Процедура Обработать(Сообщение) Экспорт
    // Логика обработки сообщения
КонецПроцедуры
```

Этот подход позволяет:
- Легко добавлять новые типы команд
- Изолировать логику обработки разных типов сообщений
- Тестировать каждую команду отдельно
- Поддерживать принцип единственной ответственности

## Фреймворк Autumn: особенности и возможности

### Dependency Injection (DI)

Autumn предоставляет мощную систему внедрения зависимостей через аннотации:

```oscript
&Пластилин
Перем МенеджерПубликаций;

&Пластилин
Перем Декомпилятор;

&Пластилин
Перем Поделка;
```

Аннотация `&Пластилин` автоматически внедряет зависимости, что позволяет:
- Избежать жесткой связанности между компонентами
- Упростить тестирование через мокирование
- Централизованно управлять жизненным циклом объектов

### Конфигурация через JSON

Autumn поддерживает конфигурацию через JSON-файлы:

```json
{
    "TELEGRAMM": {
        "TOKEN": "ваш_токен",
        "USERS": "",
        "GROUPS": ""
    },
    "GIST": {
        "TOKEN": "github_token"
    },
    "data": {
        "ИсточникиДанных": {
            "ТипКоннектора": "КоннекторJSON",
            "СтрокаСоединения": "./DataBase"
        }
    }
}
```

Доступ к конфигурации осуществляется через аннотацию `&Деталька`:

```oscript
&Деталька("TELEGRAMM.TOKEN")
Перем Токен;

&Деталька("FILEMAXSIZE")
Перем МаксимальныйРазмерФайла;
```

### Система логирования

Autumn предоставляет встроенную систему логирования:

```oscript
&ЛогПубликация
Перем Лог;

// Использование
Лог.Информация("Записываем файл");
Лог.Отладка("Детальная информация");
```

Конфигурация логгера в JSON:

```json
{
    "logos": {
        "logger": {
            "oscript.lib.share_bsl": {
                "level": "DEBUG",
                "stringlayout": "%Уровень%:%ДатаВремя% - %Сообщение%"
            }
        }
    }
}
```

## Основные компоненты системы

### 1. Менеджер публикаций

Центральный компонент, координирующий весь процесс обработки файлов:

```oscript
Функция ОбработатьФайл(ДанныеДляРазбораФайла) Экспорт
    // 1. Сохранение файла
    // 2. Разбор конфигурации
    // 3. Извлечение модулей
    // 4. Публикация
    // 5. Сохранение истории
КонецФункции
```

### 2. Декомпилятор

Отвечает за разбор конфигураций 1С:

```oscript
Процедура РазобратьФайл(ПутьКФайлу, ПапкаРазбора) Экспорт
    Параметры = Новый Массив;
    Параметры.Добавить(ПутьКФайлу);    
    Параметры.Добавить(ПапкаРазбора);

    КомандаЗапуска = КомандаЗапускаДекомпилятора.Достать(Параметры);
    КодВозврата = КомандаЗапуска.Исполнить();
КонецПроцедуры
```

### 3. Публикаторы

Реализуют интерфейс для различных сервисов публикации:

```oscript
&Желудь
&Прозвище("Публикатор")
Функция Опубликовать(ТекстыМодулей, ДанныеДляРазбораФайла) Экспорт
    // Логика публикации в конкретный сервис
КонецФункции
```

## Работа с данными

### Модели данных

Autumn Data предоставляет удобный способ работы с данными:

```oscript
&Желудь
Класс ИсторияПубликаций
    
    &Деталька("Идентификатор")
    Перем Идентификатор;
    
    &Деталька("ИДПользователя")
    Перем ИДПользователя;
    
    &Деталька("ИмяФайла")
    Перем ИмяФайла;
    
    &Деталька("ДатаОтправки")
    Перем ДатаОтправки;
    
КонецКласса
```

### Хранилища сущностей

```oscript
&Пластилин
Перем ХранилищеСущностейИсторияПубликаций;

// Создание новой записи
ИсторияПубликаций = ХранилищеСущностейИсторияПубликаций.СоздатьЭлемент();
ИсторияПубликаций.ИДПользователя = ДанныеФайла.ИДПользователя;
ИсторияПубликаций.Сохранить();

// Поиск записей
Отбор = Новый Соответствие;
Отбор.Вставить("ИДПользователя", ИДПользователя);
Сущности = МенеджерСущностей.Получить(Тип("ИсторияПубликаций"), Отбор);
```

## Обработка файлов конфигураций 1С

### Поддерживаемые форматы

Система поддерживает следующие форматы файлов:
- `.cfe` - конфигурация (внешняя)
- `.cf` - конфигурация
- `.epf` - внешняя обработка
- `.ert` - внешний отчет

### Структура разобранных файлов

После разбора конфигурации получается следующая структура:

```
_bsl/
├── Resources/
│   └── [ID ресурса]/
│       ├── Catalog/
│       │   └── [Имя справочника]/
│       │       ├── Catalog.mgr.bsl
│       │       └── Catalog.obj.bsl
│       ├── Document/
│       │   └── [Имя документа]/
│       │       ├── Document.mgr.bsl
│       │       └── Document.obj.bsl
│       └── Form/
│           └── [Имя формы]/
│               └── Form.obj.bsl
```

### Генерация оглавления

Система автоматически создает структурированное оглавление:

```markdown
# Дерево файлов

<details>
 <summary><strong> Справочник </strong></summary>
 
 | Контрагенты
 |- [Модуль менеджера](ссылка)
 |- [Модуль объекта](ссылка)
 
</details>
```

## Telegram Bot API интеграция

### Обработка обновлений

```oscript
Процедура Запустить() Экспорт
    Пока Истина Цикл
        Ответ = OPI_Telegram.ПолучитьОбновления(Токен, 30, Смещение);
        Результат = Ответ["result"];
        
        Если Результат.ВГраница() > -1 Тогда
            Сообщение = Результат[Результат.ВГраница()];
            Смещение = Сообщение["update_id"] + 1;
            
            // Обработка через команды
            Команды = Поделка.НайтиЖелуди("Команда");
            Для Каждого Команда Из Команды Цикл
                Если Команда.ПодходитПоУсловию(Сообщение) Тогда
                    Команда.Обработать(Сообщение); 
                    Прервать;
                КонецЕсли;
            КонецЦикла;
        КонецЕсли;
    КонецЦикла;
КонецПроцедуры
```

### Инлайн-клавиатуры

Для интерактивного взаимодействия используются инлайн-клавиатуры:

```oscript
Функция СформироватьКлавиатуруПоМассивуКнопок(Кнопки)
    Строки = СоздатьВысокуюКлавиатуру(Кнопки);
    СтруктураПараметра = Новый Структура("inline_keyboard, rows", Строки, 1);
    Возврат OPI_Инструменты.JSONСтрокой(СтруктураПараметра);
КонецФункции
```

## Безопасность и валидация

### Валидация файлов

```oscript
Процедура ФайлВалидный(Сообщение)
    РазмерФайла = Сообщение["message"]["document"]["file_size"];
    ИмяФайла = Сообщение["message"]["document"]["file_name"];
    
    Если РазмерФайла > МаксимальныйРазмерФайла Тогда
        ВызватьИсключение "Файл слишком большой";
    КонецЕсли;
               
    Расширение = СтрРазделить(ИмяФайла, ".");
    Если НЕ РаботаСМодулями.ДопустимоеРасширение(Расширение[Расширение.ВГраница()]) Тогда
        ВызватьИсключение "Неподдерживаемое расширение файла";
    КонецЕсли;
КонецПроцедуры
```

### Обработка ошибок

```oscript
Попытка
    ФайлВалидный(Сообщение);
Исключение
    Информация = ИнформацияОбОшибке();
    OPI_Telegram.ОтправитьТекстовоеСообщение(Токен, ЧатИД, Информация.Описание);
КонецПопытки;
```

## Масштабируемость и расширяемость

### Добавление новых публикаторов

Для добавления нового сервиса публикации достаточно создать класс с аннотацией `&Прозвище("Публикатор")`:

```oscript
&Желудь
&Прозвище("Публикатор")
Класс ПубликаторНовыйСервис
    
    Функция Опубликовать(ТекстыМодулей, ДанныеДляРазбораФайла) Экспорт
        // Реализация публикации
        Возврат Ссылки;
    КонецФункции
    
КонецКласса
```

### Конфигурация сервисов

Сервисы настраиваются через конфигурацию:

```json
{
    "SHARESERVICE": "ПубликаторGist, ПубликаторНовыйСервис"
}
```

## Тестирование

### Структура тестов

```
tests/
├── fixtures/
│   ├── До/
│   │   └── ТестовоеРасширение.cfe
│   └── После/
│       └── ТестовоеРасширение.cfe
└── maintest.os
```

### Пример теста

```oscript
#Использовать "./tests"

Процедура ТестРазбораФайла()
    // Подготовка
    ТестовыйФайл = "tests/fixtures/До/ТестовоеРасширение.cfe";
    
    // Действие
    Результат = Декомпилятор.РазобратьФайл(ТестовыйФайл, "temp/");
    
    // Проверка
    Утверждение.Равно(Результат, ОжидаемыйРезультат);
КонецПроцедуры
```

## Развертывание

### Docker контейнеризация

```dockerfile
FROM oscript/onescript:latest

WORKDIR /app
COPY . .

RUN oscript -compile main.os

CMD ["oscript", "main.os"]
```

### Переменные окружения

```bash
export TELEGRAMM_TOKEN="ваш_токен"
export GIST_TOKEN="github_token"
export FILEMAXSIZE=30000000
export UNPACK=py
```

## Заключение

Данный проект демонстрирует возможности современной разработки на платформе 1С с использованием:

1. **Архитектурных паттернов** - Command, Dependency Injection, Repository
2. **Современного фреймворка** - Autumn с поддержкой DI, логирования, конфигурации
3. **Модульной архитектуры** - четкое разделение ответственности
4. **Расширяемости** - легкое добавление новых публикаторов
5. **Безопасности** - валидация входных данных, обработка ошибок

Такой подход позволяет создавать сложные, масштабируемые приложения, которые легко поддерживать и расширять.

## Полезные ссылки

- [1Script Documentation](https://oscript.io/)
- [Autumn Framework](https://github.com/EvilBeaver/autumn)
- [Telegram Bot API](https://core.telegram.org/bots/api)
- [GitHub Gist API](https://docs.github.com/en/rest/gists) 